<h2>Hosts</h2>
<div class="d-flex justify-content-between mb-3">
  <button type="button" class="btn btn-primary bt-newhost" data-toggle="modal" data-target="#hostModal">New Host</button>
</div>
<table class="table table-dark" id="hosts">
  <thead>
    <tr>
      <th scope="col">ID</th>
      <th scope="col">Name</th>
      <th scope="col">Type</th>
      <th scope="col">W.Endpoint</th>
      <th scope="col">R.Endpoint</th>
      <th scope="col">Port</th>
      <th scope="col">Username</th>
      <th scope="col">Included by</th>
      <th scope="col">Created at</th>
      <th scope="col">Updated at</th>
      <th scope="col">Actions</th>
      </tr>
  </thead>
  <tbody>
    </tbody>
</table>

<script>
  $(document).ready(function() {
    function ini_table(){
      $.getJSON('/getHosts', function (hosts) {
          if (!Array.isArray(hosts)) return; // If the response is not an array, it's a single object so convert
          $('#hosts > tbody').empty();
          for (var i in hosts){
            // console.log(hosts[i]);
            var host_id=hosts[i].id;
            // '<a href="/hosts/' + host_id + '">' + hosts[i].name + '</a></td>' +
            $('#hosts > tbody:last').append('<tr><td>'+host_id+'</td>' +
              '<td>' + hosts[i].name + '</td>' +
              '<td>' + hosts[i].type + '</td>' +
              '<td>' + hosts[i].ipaddress + '</td>' +
              '<td>' + hosts[i].ipaddress_read + '</td>' +
              '<td>' + hosts[i].port + '</td>' +
              '<td>' + hosts[i].username + '</td>' +
              '<td>' + hosts[i].id_user + '</td>' +
              '<td>' + moment(hosts[i].createdAt).format("YYYY/MM/DD HH:mm") + '</td>' +
              '<td>' + moment(hosts[i].updatedAt).format("YYYY/MM/DD HH:mm") + '</td>' +
              '<td><button class="btn btn-sm btn-success bt-sync" host_id="'+ hosts[i].id +'"><i class="bi bi-arrow-down-up"></i> sync</button> ' +
                  '<button class="btn btn-sm btn-danger bt-remove" host_id="'+ hosts[i].id +'"><i class="bi bi-trash3-fill"></i> remove+all</button></td>' +
              '</tr>');
          }              
          $('.bt-sync').click(function(e) {
            e.preventDefault();
            var _bt = $(this);
            var _btcontent = $(this).html();
              if(confirm('Sync every databases and tables?')){
                $(this).html('<i class="fas fa-sync fa-spin"></i>');
                $.get( "/synchosts/" + $(this).attr('host_id'), function( returned ) {
                  _bt.html(_btcontent);
                  console.log(returned);
                });
              }
          });
          $('.bt-remove').click(function(e) {
            e.preventDefault();
            var _bt = $(this);
            var _btcontent = $(this).html();
              if(confirm('Remove all sessions + tables + databases + this host?')){
                $(this).html('<i class="fas fa-sync fa-spin"></i>');
                var request_data = JSON.stringify({'data': {host_id: $(this).attr('host_id')}});
                $.ajax({
                  type: 'POST',
                  async : false,
                  url: '/removeHostAndAllTogether',
                  data: request_data,
                  success: function(status) { 
                    ini_table();
                  },
                  contentType: "application/json",
                  dataType: 'json'
                });
              }
          });
      });
      $('.bt-newhost').click(function(e) {
          e.preventDefault();
          var target = $(this).data('target');
          $('#content-area').load('hosts_new.html'); // Load content based on menu item
      });
    }
    ini_table();
  });
</script>